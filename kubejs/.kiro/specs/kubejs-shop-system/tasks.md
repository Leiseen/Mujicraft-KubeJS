# 实现计划: KubeJS 商店系统

## 概述

本实现计划将 KubeJS 商店系统分解为离散的编码步骤。系统完全基于 KubeJS 6 脚本实现，使用 JavaScript 编写。实现将采用增量方式，每个任务都建立在前一个任务的基础上，确保核心功能尽早通过代码验证。

## 任务

- [x] 1. 设置项目结构和配置管理模块
  - 创建目录结构 `kubejs/config/shop/` 用于存放配置文件
  - 创建 `server_scripts/shop/` 目录用于存放商店脚本
  - 实现配置管理器 `ConfigManager`，包括 JSON 文件读取、解析和验证功能
  - 创建默认配置文件模板（products.json, currencies.json, shop_item.json, messages.json）
  - 实现配置缓存机制以提高性能
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 10.4, 10.5_

- [x] 1.1 编写配置管理器的属性测试
  - **属性 1: 配置热加载一致性**
  - **属性 2: 无效配置回退**
  - **属性 4: 配置解析完整性**
  - **验证: 需求 1.1, 1.2, 1.3, 4.1, 4.2, 4.4, 4.5**

- [ ] 2. 实现商店物品识别和事件处理
  - 在 `server_scripts/shop/event_handler.js` 中实现事件处理器
  - 使用 `ItemEvents.rightClicked` 监听玩家右键点击事件
  - 实现 NBT 标签检查逻辑，识别带有 `{shop_item: true}` 的物品
  - 实现商店物品配置加载和显示名称/描述应用
  - 添加调试日志输出以便测试
  - _需求: 2.1, 2.2, 2.3, 2.4, 10.1, 10.2_

- [ ] 2.1 编写商店物品识别的属性测试
  - **属性 3: 商店物品识别**
  - **验证: 需求 2.1, 2.2, 2.3**

- [ ] 3. 实现货币系统和价格计算
  - 在 `server_scripts/shop/currency_manager.js` 中实现货币管理器
  - 实现货币价值计算函数 `calculateRequiredAmount(basePrice, currencyValue)`
  - 实现玩家背包货币统计函数 `countCurrency(player, currencyId)`
  - 实现货币 NBT 标签匹配功能（可选）
  - 实现货币扣除函数 `removeCurrency(player, currencyId, amount)`
  - 添加货币类型验证逻辑
  - _需求: 5.1, 5.2, 5.3, 5.5, 5.6_

- [ ] 3.1 编写货币系统的属性测试
  - **属性 7: 货币价值计算正确性**
  - **属性 8: 多货币支持**
  - **属性 9: 货币类型验证**
  - **属性 17: NBT 货币匹配**
  - **验证: 需求 5.1, 5.2, 5.3, 5.5, 5.6**

- [ ] 4. 检查点 - 确保配置和货币系统正常工作
  - 确保所有测试通过，如有问题请询问用户

- [ ] 5. 实现 GUI 管理器和商品展示
  - 在 `server_scripts/shop/gui_manager.js` 中实现 GUI 管理器
  - 实现箱子 GUI 创建函数 `openShopGUI(player, page)`
  - 实现商品图标渲染函数 `createProductIcon(product)`，包含名称、价格和货币信息
  - 实现分页逻辑，每页显示 45 个商品
  - 添加翻页按钮（上一页、下一页）到固定位置（第 49、51 格）
  - 添加关闭按钮到第 50 格
  - 实现装饰性填充物品
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 5.1 编写 GUI 渲染的属性测试
  - **属性 5: GUI 商品渲染完整性**
  - **属性 6: 分页逻辑正确性**
  - **验证: 需求 3.1, 3.3, 3.4**

- [ ] 5.2 编写 GUI 边界情况的单元测试
  - 测试空商品列表
  - 测试单页商品显示
  - 测试背包已满情况
  - _需求: 3.6_

- [ ] 6. 实现交易处理器和验证逻辑
  - 在 `server_scripts/shop/transaction_handler.js` 中实现交易处理器
  - 实现交易验证函数 `validateTransaction(player, product)`
  - 实现货币充足性检查 `hasSufficientCurrency(player, currency, amount)`
  - 实现背包空间检查功能
  - 实现交易执行函数 `processPurchase(player, product)`
  - 实现交易回滚机制 `rollbackTransaction(player, currency, amount)`
  - 添加用户反馈消息发送功能
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [ ] 6.1 编写交易处理的属性测试
  - **属性 10: 货币充足性验证**
  - **属性 11: 交易原子性**
  - **验证: 需求 6.1, 6.2, 6.3, 6.4, 6.6**

- [ ] 6.2 编写交易错误处理的单元测试
  - 测试货币不足情况
  - 测试货币类型不匹配
  - 测试交易回滚机制
  - _需求: 6.2, 6.6_

- [ ] 7. 实现日志记录系统
  - 在 `server_scripts/shop/logger.js` 中实现日志记录器
  - 实现交易日志记录函数 `logTransaction(player, product, currency, amount, success)`
  - 使用 JSON Lines 格式记录日志
  - 实现日志文件路径管理（`kubejs/logs/shop_transactions.log`）
  - 实现日志文件大小检查和自动分割功能
  - 实现错误日志记录函数 `logError(message, error)`
  - 确保日志写入异步执行，不阻塞游戏
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

- [ ] 7.1 编写日志系统的属性测试
  - **属性 12: 交易日志完整性**
  - **属性 13: 日志格式有效性**
  - **验证: 需求 7.1, 7.2, 7.3, 7.4**

- [ ] 7.2 编写日志管理的单元测试
  - 测试日志文件创建
  - 测试日志文件分割
  - 测试日志写入失败处理
  - _需求: 7.5_

- [ ] 8. 实现系统商店特性和无限供应
  - 确保商品购买不减少库存（系统商店特性）
  - 实现商品可用性检查（始终返回 true）
  - 验证多次购买同一商品的功能
  - 确保架构支持未来扩展玩家间交易（使用接口或抽象层）
  - _需求: 8.1, 8.2, 8.3, 8.4_

- [ ] 8.1 编写系统商店特性的属性测试
  - **属性 14: 无限供应特性**
  - **验证: 需求 8.1, 8.2**

- [ ] 9. 实现错误处理和用户反馈系统
  - 在 `server_scripts/shop/message_handler.js` 中实现消息处理器
  - 实现消息模板加载和变量替换功能
  - 为所有错误类型创建清晰的中文错误消息
  - 实现货币不足时显示详细信息（需要/当前数量）
  - 实现背包已满提示
  - 添加 Minecraft 颜色代码支持
  - 实现消息配置热加载
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_

- [ ] 9.1 编写消息系统的属性测试
  - **属性 15: 错误消息完整性**
  - **属性 16: 消息配置可定制性**
  - **验证: 需求 9.1, 9.4, 9.6**

- [ ] 9.2 编写错误消息的单元测试
  - 测试各种错误场景的消息
  - 测试消息变量替换
  - 测试颜色代码应用
  - _需求: 9.3, 9.4_

- [ ] 10. 实现配置热加载命令
  - 创建 KubeJS 自定义命令 `/shop reload` 用于重载配置
  - 实现配置重载逻辑，调用 `ConfigManager.reloadConfigs()`
  - 添加权限检查（仅管理员可用）
  - 实现重载成功/失败反馈消息
  - 记录配置重载事件到日志
  - _需求: 1.1, 1.2_

- [ ] 10.1 编写配置重载的单元测试
  - 测试重载命令执行
  - 测试权限检查
  - 测试重载失败处理
  - _需求: 1.2, 1.3_

- [ ] 11. 检查点 - 集成测试和完整功能验证
  - 确保所有测试通过，如有问题请询问用户

- [ ] 12. 整合所有模块并实现主入口
  - 在 `server_scripts/shop/main.js` 中创建主入口文件
  - 初始化所有管理器（ConfigManager, GUIManager, TransactionHandler, Logger）
  - 注册所有事件监听器
  - 实现模块间的依赖注入
  - 添加启动日志输出
  - 确保所有模块正确协同工作
  - _需求: 10.1, 10.2, 10.3_

- [ ] 12.1 编写集成测试
  - 测试完整的购买流程（从打开 GUI 到交易完成）
  - 测试配置热加载对运行中系统的影响
  - 测试多玩家并发购买场景
  - _需求: 所有需求_

- [ ] 13. 创建示例配置和文档
  - 创建示例商品配置，包含多种商品
  - 创建示例货币配置，包含多种货币和不同价值
  - 创建商店物品获取命令示例
  - 编写配置文件说明文档（中文）
  - 编写管理员使用指南
  - 添加常见问题解答
  - _需求: 所有需求_

- [ ] 14. 最终检查点 - 完整系统测试
  - 在实际 Minecraft 服务器环境中测试所有功能
  - 验证热加载功能
  - 验证多玩家交易
  - 检查日志文件生成
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 所有代码使用 JavaScript 编写，基于 KubeJS 6 API
- 配置文件使用 JSON 格式，支持热加载
- 日志使用 JSON Lines 格式便于解析
- 所有测试任务都是必需的，确保从一开始就有全面的测试覆盖
